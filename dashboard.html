<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Gainly</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <h2>Gainly</h2>
            </div>
            <div class="nav-links">
                <a href="dashboard.html" class="nav-link active">Dashboard</a>
                <a href="calories.html" class="nav-link">Calories</a>
                <a href="workouts.html" class="nav-link">Workouts</a>
                <a href="recipes.html" class="nav-link">Recipes</a>
                <a href="progress.html" class="nav-link">Progress</a>
                <a href="profile.html" class="nav-link">Profile</a>
            </div>
            <button onclick="logout()" class="btn btn-small">Logout</button>
        </div>
    </nav>

    <div class="main-content">
        <div class="dashboard-container">
            <div class="dashboard-header">
                <h1>Welcome back, <span id="userName"></span>!</h1>
                <p class="date-display" id="currentDate"></p>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <h3>Today's Calories</h3>
                        <a href="calories.html" class="stat-link">View Details ‚Üí</a>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">
                            <span id="caloriesConsumed">0</span> / <span id="caloriesTarget">2000</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="caloriesProgress" style="width: 0%"></div>
                        </div>
                        <p class="stat-label"><span id="caloriesRemaining">2000</span> calories remaining</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <h3>Today's Workouts</h3>
                        <a href="workouts.html" class="stat-link">View Details ‚Üí</a>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="workoutsCount">0</div>
                        <p class="stat-label">workouts completed</p>
                        <button onclick="window.location.href='workouts.html'" class="btn btn-secondary btn-small">Log Workout</button>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <h3>Weight Progress</h3>
                        <a href="progress.html" class="stat-link">View Details ‚Üí</a>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="latestWeight">‚Äî</div>
                        <p class="stat-label" id="weightChange">No weight logged</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <h3>Workout Streak</h3>
                        <a href="progress.html" class="stat-link">View Details ‚Üí</a>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number" id="workoutStreak">0</div>
                        <p class="stat-label" id="streakLabel">days</p>
                    </div>
                </div>
            </div>
            <div class="recent-activity">
                <h2>Recent Activity</h2>
                <div id="activityList" class="activity-list">
                    <p class="empty-state">No activity yet. Start tracking your calories or workouts!</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://bit-portfolio-1.onrender.com';
        
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!token) {
            window.location.href = 'login.html';
        } else {
            document.getElementById('userName').textContent = user.name || 'User';
        }

        function getUserPrefix() {
            return user.id ? user.id + '_' : '';
        }

        const today = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('currentDate').textContent = today.toLocaleDateString('en-US', options);

        loadTodayStats();

        async function loadTodayStats() {
            const meals = JSON.parse(localStorage.getItem('meals_' + getUserPrefix() + getTodayDate()) || '[]');
            const totalCalories = meals.reduce((sum, meal) => sum + meal.calories, 0);
            const target = parseInt(localStorage.getItem('calorieGoal_' + getUserPrefix().slice(0, -1)) || '2000'); // Default target
            
            document.getElementById('caloriesConsumed').textContent = totalCalories;
            document.getElementById('caloriesTarget').textContent = target;
            document.getElementById('caloriesRemaining').textContent = target - totalCalories;
            
            const percentage = Math.min((totalCalories / target) * 100, 100);
            document.getElementById('caloriesProgress').style.width = percentage + '%';

            const workouts = JSON.parse(localStorage.getItem('workouts_' + getUserPrefix() + getTodayDate()) || '[]');
            document.getElementById('workoutsCount').textContent = workouts.length;

            loadWeightProgress();

            loadWorkoutStreak();

            loadRecentActivity(meals, workouts);
        }

        function loadWeightProgress() {

            const today = new Date();
            const weightEntries = [];

            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateKey = date.toISOString().split('T')[0];
                const weightData = localStorage.getItem('weight_' + getUserPrefix() + dateKey);
                
                if (weightData) {
                    try {
                        const weight = JSON.parse(weightData);
                        weightEntries.push({
                            date: dateKey,
                            value: weight.value,
                            unit: weight.unit
                        });
                    } catch (e) {

                    }
                }
            }

            if (weightEntries.length === 0) {
                document.getElementById('latestWeight').textContent = '‚Äî';
                document.getElementById('weightChange').textContent = 'No weight logged';
                return;
            }


            weightEntries.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const latest = weightEntries[0];
            document.getElementById('latestWeight').textContent = `${latest.value} ${latest.unit}`;


            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 7);
            const sevenDaysKey = sevenDaysAgo.toISOString().split('T')[0];
            
            const weekEntry = weightEntries.find(w => w.date === sevenDaysKey);
            if (weekEntry) {
                const change = latest.value - weekEntry.value;
                const sign = change > 0 ? '+' : '';
                document.getElementById('weightChange').textContent = `${sign}${change.toFixed(1)} ${latest.unit} this week`;
            } else {
                document.getElementById('weightChange').textContent = 'Track for 7+ days to see change';
            }
        }

        function loadWorkoutStreak() {

            const today = new Date();
            let streak = 0;
            let currentDate = new Date(today);

            for (let i = 0; i < 100; i++) {
                const dateKey = currentDate.toISOString().split('T')[0];
                const workouts = JSON.parse(localStorage.getItem('workouts_' + getUserPrefix() + dateKey) || '[]');
                
                if (workouts.length > 0) {
                    streak++;
                    currentDate.setDate(currentDate.getDate() - 1);
                } else {
                    if (i > 0) {
                        break;
                    }
                    currentDate.setDate(currentDate.getDate() - 1);
                }
            }

            document.getElementById('workoutStreak').textContent = streak;
            document.getElementById('streakLabel').textContent = streak === 1 ? 'day' : 'days';
        }

        function loadRecentActivity(meals, workouts) {
            const activityList = document.getElementById('activityList');
            const activities = [];

            meals.forEach(meal => {
    activities.push({
        type: 'meal',
        text: `Logged ${meal.name} - ${meal.calories} calories`,
        time: meal.timestamp
    });
});

workouts.forEach(workout => {
    activities.push({
        type: 'workout',
        text: `Completed ${workout.name}`,
        time: workout.timestamp
    });
});

            if (activities.length === 0) {
                activityList.innerHTML = '<p class="empty-state">No activity yet. Start tracking your calories or workouts!</p>';
                return;
            }

            activities.sort((a, b) => new Date(b.time) - new Date(a.time));

            activityList.innerHTML = activities.slice(0, 5).map(activity => `
                <div class="activity-item">
                    <span class="activity-icon">${activity.type === 'meal' ? 'üçΩÔ∏è' : 'üí™'}</span>
                    <div class="activity-text">
                        <p>${activity.text}</p>
                        <span class="activity-time">${formatTime(activity.time)}</span>
                    </div>
                </div>
            `).join('');
        }

        function getTodayDate() {
            return new Date().toISOString().split('T')[0];
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor(diff / 60000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            return date.toLocaleDateString();
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>