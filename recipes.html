<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Recipes - Gainly</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .page-container { max-width: 1200px; margin: 0 auto; }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 18px;
      margin-bottom: 30px;
    }

    .page-header h1 {
      font-size: 2.5rem;
      margin-bottom: 6px;
      color: #ffffff;
    }

    .page-subtitle {
      color: #999;
      font-size: 1rem;
      line-height: 1.6;
      max-width: 820px;
    }

    .toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 12px;
    }

    .search {
      flex: 1;
      min-width: 220px;
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.03);
    }

    .search input {
      width: 100%;
      border: none;
      outline: none;
      background: transparent;
      color: #fff;
      font-size: 0.95rem;
    }

    .search input::placeholder { color: rgba(255,255,255,0.35); }

    .select {
      min-width: 200px;
    }

    .select select {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.03);
      color: #fff;
      font-size: 0.95rem;
      outline: none;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(290px, 1fr));
      gap: 18px;
      margin-top: 20px;
    }

    .recipe-card {
      background: linear-gradient(145deg, #1a1a1a, #0f0f0f);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 22px;
      transition: transform 0.25s ease, border-color 0.25s ease;
      position: relative;
      overflow: hidden;
    }

    .recipe-card:hover {
      transform: translateY(-3px);
      border-color: rgba(255,255,255,0.18);
    }

    .recipe-title {
      font-size: 1.25rem;
      font-weight: 800;
      color: #fff;
      margin: 0 0 10px 0;
    }

    .recipe-meta {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 14px;
      color: #999;
      font-size: 0.9rem;
    }

    .chip {
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.03);
      padding: 6px 10px;
      border-radius: 999px;
      color: #ccc;
      font-size: 0.85rem;
    }

    .macros {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin: 14px 0;
    }

    .macro {
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.03);
      padding: 12px;
      text-align: center;
    }

    .macro .v {
      font-size: 1.25rem;
      font-weight: 800;
      color: #fff;
      margin-bottom: 4px;
    }

    .macro .k {
      color: #999;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }

    .recipe-desc {
      color: #999;
      line-height: 1.7;
      font-size: 0.95rem;
      margin: 10px 0 16px 0;
      min-height: 48px;
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 10px;
    }

    .top-note {
      color: #666;
      font-size: 0.9rem;
      margin-top: 14px;
      line-height: 1.6;
    }

    .ingredient-row {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }

    .ingredient-row input {
      padding: 8px 12px;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      background: rgba(255,255,255,0.05);
      color: #fff;
      font-size: 0.9rem;
    }

    .ingredient-row input:focus {
      outline: none;
      border-color: #fff;
    }

    .ingredient-row .ingredient-name {
      flex: 2;
    }

    .ingredient-row .ingredient-amount {
      flex: 1;
      max-width: 80px;
    }

    .ingredient-row .ingredient-unit {
      flex: 1;
      max-width: 100px;
    }

    @media (max-width: 900px) {
      .page-header h1 { font-size: 2.1rem; }
      .macros { grid-template-columns: repeat(2, 1fr); }
      .ingredient-row { flex-direction: column; align-items: stretch; }
      .ingredient-row input { width: 100%; }
    }
  </style>
</head>

<body>

  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-brand">
        <h2>Gainly</h2>
      </div>
      <div class="nav-links">
        <a href="dashboard.html" class="nav-link">Dashboard</a>
        <a href="calories.html" class="nav-link">Calories</a>
        <a href="workouts.html" class="nav-link">Workouts</a>
        <a href="recipes.html" class="nav-link active">
          Recipes
        </a>
        <a href="progress.html" class="nav-link">
          Progress
        </a>
        <a href="profile.html" class="nav-link">Profile</a>
      </div>
      <button onclick="logout()" class="btn btn-small">Logout</button>
    </div>
  </nav>

  <div class="main-content">
    <div class="page-container">
      <div class="page-header">
        <div>
          <h1>Recipes</h1>
          <p class="page-subtitle">
            Create and manage your own recipes with nutritional breakdown. Add ingredients and calories yourself.
          </p>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" onclick="openAddRecipeModal()">Add Recipe</button>
          <button class="btn btn-secondary btn-small" onclick="render()">Refresh</button>
        </div>
      </div>

      <div class="toolbar">
        <div class="search">
          <input id="searchInput" type="text" placeholder="Search recipes..." />
        </div>

        <div class="select">
          <select id="filterSelect">
            <option value="all">All Categories</option>
            <option value="breakfast">Breakfast</option>
            <option value="lunch">Lunch</option>
            <option value="dinner">Dinner</option>
            <option value="snack">Snack</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="select" style="min-width:220px;">
          <select id="sortSelect">
            <option value="default">Sort: Recent</option>
            <option value="cal-asc">Calories: Low to High</option>
            <option value="cal-desc">Calories: High to Low</option>
            <option value="name">Name: A-Z</option>
          </select>
        </div>
      </div>

      <div class="grid" id="recipesGrid"></div>
    </div>
  </div>


  <div id="addRecipeModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <span class="modal-close" onclick="closeAddRecipeModal()">&times;</span>
      <h2>Add Custom Recipe</h2>
      <form id="addRecipeForm">
        <div class="form-group">
          <label for="recipeName">Recipe Name</label>
          <input type="text" id="recipeName" required placeholder="e.g., Chicken Stir Fry">
        </div>

        <div class="form-group">
          <label for="recipeCategory">Category</label>
          <select id="recipeCategory" required>
            <option value="breakfast">Breakfast</option>
            <option value="lunch">Lunch</option>
            <option value="dinner">Dinner</option>
            <option value="snack">Snack</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="form-group">
          <label for="recipeServings">Servings</label>
          <input type="number" id="recipeServings" required min="1" value="1">
        </div>

        <div class="form-group">
          <label for="recipeTime">Prep/Cook Time (minutes)</label>
          <input type="number" id="recipeTime" required min="1" value="30">
        </div>

        <div class="form-group">
          <label>Ingredients</label>
          <div id="ingredientsList">
            <div class="ingredient-row">
              <input type="text" placeholder="Ingredient name" class="ingredient-name" required>
              <input type="number" placeholder="Amount" class="ingredient-amount" min="0" step="0.1" required>
              <input type="text" placeholder="Unit (g, cups, etc.)" class="ingredient-unit" required>
              <button type="button" onclick="removeIngredient(this)" class="btn btn-secondary btn-small">Remove</button>
            </div>
          </div>
          <button type="button" onclick="addIngredient()" class="btn btn-secondary btn-small" style="margin-top: 10px;">Add Ingredient</button>
        </div>

        <div class="form-group">
          <label for="recipeCalories">Total Calories (per serving)</label>
          <input type="number" id="recipeCalories" required min="0">
        </div>

        <div class="form-group">
          <label for="recipeProtein">Protein (g per serving)</label>
          <input type="number" id="recipeProtein" required min="0" step="0.1">
        </div>

        <div class="form-group">
          <label for="recipeCarbs">Carbs (g per serving)</label>
          <input type="number" id="recipeCarbs" required min="0" step="0.1">
        </div>

        <div class="form-group">
          <label for="recipeFat">Fat (g per serving)</label>
          <input type="number" id="recipeFat" required min="0" step="0.1">
        </div>

        <div class="form-group">
          <label for="recipeDescription">Description</label>
          <textarea id="recipeDescription" placeholder="Brief description of the recipe..." rows="3"></textarea>
        </div>

        <button type="submit" class="btn btn-large">Save Recipe</button>
      </form>
    </div>
  </div>

  <script>

    const token = localStorage.getItem('token');
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    if (!token) window.location.href = 'login.html';

    function getUserPrefix() {
        return user.id ? user.id + '_' : '';
    }

    function getTodayDate() {
      return new Date().toISOString().split('T')[0];
    }


    function loadRecipes() {
      return JSON.parse(localStorage.getItem('customRecipes_' + getUserPrefix().slice(0, -1)) || '[]');
    }


    function saveRecipes(recipes) {
      localStorage.setItem('customRecipes_' + getUserPrefix().slice(0, -1), JSON.stringify(recipes));
    }

    function passesFilter(recipe, query, category) {
      const q = (query || '').trim().toLowerCase();
      const matchQuery = !q || recipe.name.toLowerCase().includes(q) || recipe.description.toLowerCase().includes(q);
      const matchCategory = (category === 'all') || (recipe.category === category);
      return matchQuery && matchCategory;
    }

    function sortRecipes(list, sortKey) {
      const arr = [...list];
      if (sortKey === 'cal-asc') return arr.sort((a,b) => a.calories - b.calories);
      if (sortKey === 'cal-desc') return arr.sort((a,b) => b.calories - a.calories);
      if (sortKey === 'name') return arr.sort((a,b) => a.name.localeCompare(b.name));
      return arr.reverse(); 
    }

    function render() {
      const query = document.getElementById('searchInput').value;
      const category = document.getElementById('filterSelect').value;
      const sortKey = document.getElementById('sortSelect').value;

      const recipes = loadRecipes();
      const filtered = recipes.filter(r => passesFilter(r, query, category));
      const sorted = sortRecipes(filtered, sortKey);

      const grid = document.getElementById('recipesGrid');

      if (sorted.length === 0) {
        grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1;">No recipes found. <button class="btn btn-secondary btn-small" onclick="openAddRecipeModal()">Add your first recipe</button></div>`;
        return;
      }

      grid.innerHTML = sorted.map(r => cardHTML(r)).join('');
    }



    function cardHTML(r) {
      const ingredientsText = r.ingredients.map(ing => `${ing.amount} ${ing.unit} ${ing.name}`).join(', ');
      return `
        <div class="recipe-card">
          <h3 class="recipe-title">${escapeHtml(r.name)}</h3>
          <div class="recipe-meta">
            <span class="chip">${escapeHtml(labelCategory(r.category))}</span>
            <span class="chip">${r.minutes} min</span>
            <span class="chip">${r.servings} serving${r.servings !== 1 ? 's' : ''}</span>
          </div>

          <div class="macros">
            <div class="macro"><div class="v">${r.calories}</div><div class="k">Calories</div></div>
            <div class="macro"><div class="v">${r.protein}g</div><div class="k">Protein</div></div>
            <div class="macro"><div class="v">${r.carbs}g</div><div class="k">Carbs</div></div>
            <div class="macro"><div class="v">${r.fat}g</div><div class="k">Fat</div></div>
          </div>

          <p class="recipe-desc">${escapeHtml(r.description || 'No description')}</p>
          <p class="recipe-desc" style="font-size: 0.9rem; color: #888;">Ingredients: ${escapeHtml(ingredientsText)}</p>

          <div class="actions">
            <button class="btn btn-small" onclick="addToToday('${r.id}')">Add to Today</button>
            <button class="btn btn-secondary btn-small" onclick="openDetails('${r.id}')">Details</button>
            <button class="btn btn-secondary btn-small" onclick="deleteRecipe('${r.id}')">Delete</button>
          </div>
        </div>
      `;
    }

    function labelCategory(cat) {
      const labels = {
        'breakfast': 'Breakfast',
        'lunch': 'Lunch',
        'dinner': 'Dinner',
        'snack': 'Snack',
        'other': 'Other'
      };
      return labels[cat] || 'Recipe';
    }

    function addToToday(recipeId) {
      const recipes = loadRecipes();
      const recipe = recipes.find(r => r.id === recipeId);
      if (!recipe) return;

      const meal = {
        name: recipe.name,
        type: 'Meal',
        calories: recipe.calories,
        protein: recipe.protein,
        carbs: recipe.carbs,
        fat: recipe.fat,
        notes: 'Added from Recipes',
        timestamp: new Date().toISOString()
      };

      const today = getTodayDate();
      const key = 'meals_' + getUserPrefix() + today;
      const meals = JSON.parse(localStorage.getItem(key) || '[]');
      meals.push(meal);
      localStorage.setItem(key, JSON.stringify(meals));

      showToast('Added to today\'s meals.', 'success');
    }

    function openDetails(recipeId) {
      const recipes = loadRecipes();
      const recipe = recipes.find(r => r.id === recipeId);
      if (!recipe) return;

      const ingredientsText = recipe.ingredients.map(ing => `- ${ing.amount} ${ing.unit} ${ing.name}`).join('\n');

      const lines = [
        recipe.name,
        '',
        `Category: ${labelCategory(recipe.category)}`,
        `Time: ${recipe.minutes} minutes`,
        `Servings: ${recipe.servings}`,
        '',
        `Calories: ${recipe.calories}`,
        `Protein: ${recipe.protein}g`,
        `Carbs: ${recipe.carbs}g`,
        `Fat: ${recipe.fat}g`,
        '',
        'Ingredients:',
        ingredientsText,
        '',
        recipe.description || 'No description'
      ];

      alert(lines.join('\n'));
    }

    function deleteRecipe(recipeId) {
      if (!confirm('Are you sure you want to delete this recipe?')) return;

      const recipes = loadRecipes();
      const filtered = recipes.filter(r => r.id !== recipeId);
      saveRecipes(filtered);
      render();
      showToast('Recipe deleted.', 'success');
    }

    function openAddRecipeModal() {
      document.getElementById('addRecipeModal').style.display = 'flex';
      document.getElementById('addRecipeForm').reset();
      document.getElementById('ingredientsList').innerHTML = `
        <div class="ingredient-row">
          <input type="text" placeholder="Ingredient name" class="ingredient-name" required>
          <input type="number" placeholder="Amount" class="ingredient-amount" min="0" step="0.1" required>
          <input type="text" placeholder="Unit (g, cups, etc.)" class="ingredient-unit" required>
          <button type="button" onclick="removeIngredient(this)" class="btn btn-secondary btn-small">Remove</button>
        </div>
      `;
    }

    function closeAddRecipeModal() {
      document.getElementById('addRecipeModal').style.display = 'none';
    }

    function addIngredient() {
      const row = document.createElement('div');
      row.className = 'ingredient-row';
      row.innerHTML = `
        <input type="text" placeholder="Ingredient name" class="ingredient-name" required>
        <input type="number" placeholder="Amount" class="ingredient-amount" min="0" step="0.1" required>
        <input type="text" placeholder="Unit (g, cups, etc.)" class="ingredient-unit" required>
        <button type="button" onclick="removeIngredient(this)" class="btn btn-secondary btn-small">Remove</button>
      `;
      document.getElementById('ingredientsList').appendChild(row);
    }

    function removeIngredient(button) {
      const rows = document.querySelectorAll('.ingredient-row');
      if (rows.length > 1) {
        button.closest('.ingredient-row').remove();
      } else {
        showToast('You must have at least one ingredient.', 'warning');
      }
    }

    document.getElementById('addRecipeForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const ingredients = [];
      document.querySelectorAll('.ingredient-row').forEach(row => {
        const name = row.querySelector('.ingredient-name').value.trim();
        const amount = parseFloat(row.querySelector('.ingredient-amount').value);
        const unit = row.querySelector('.ingredient-unit').value.trim();

        if (name && !isNaN(amount) && unit) {
          ingredients.push({ name, amount, unit });
        }
      });

      if (ingredients.length === 0) {
        showToast('Please add at least one ingredient.', 'error');
        return;
      }

      const recipe = {
        id: Date.now().toString(),
        name: document.getElementById('recipeName').value.trim(),
        category: document.getElementById('recipeCategory').value,
        servings: parseInt(document.getElementById('recipeServings').value),
        minutes: parseInt(document.getElementById('recipeTime').value),
        calories: parseInt(document.getElementById('recipeCalories').value),
        protein: parseFloat(document.getElementById('recipeProtein').value),
        carbs: parseFloat(document.getElementById('recipeCarbs').value),
        fat: parseFloat(document.getElementById('recipeFat').value),
        description: document.getElementById('recipeDescription').value.trim(),
        ingredients: ingredients,
        createdAt: new Date().toISOString()
      };

      const recipes = loadRecipes();
      recipes.push(recipe);
      saveRecipes(recipes);

      closeAddRecipeModal();
      render();
      showToast('Recipe added successfully!', 'success');
    });

    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => toast.remove(), 3000);
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = 'index.html';
    }

    document.getElementById('searchInput').addEventListener('input', render);
    document.getElementById('filterSelect').addEventListener('change', render);
    document.getElementById('sortSelect').addEventListener('change', render);

    window.onclick = function(event) {
      const modal = document.getElementById('addRecipeModal');
      if (event.target === modal) closeAddRecipeModal();
    };


    render();
  </script>
</body>
</html>
